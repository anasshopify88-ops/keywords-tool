<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>اعرف الكلمات المفتاحية الخاصة بمنافسيك</title>
<style>
  :root{
    --bg:#0b0c0f;--card:#12141a;--text:#e9eef6;--muted:#a9b3c1;--accent:#3b82f6;
    --ok:#16a34a;--warn:#f59e0b;--error:#ef4444;--border:#222733;--shadow:0 6px 24px rgba(0,0,0,.25)
  }
  :root[data-theme="light"]{
    --bg:#f7f8fb;--card:#fff;--text:#0c1424;--muted:#5b6472;--accent:#2563eb;
    --ok:#15803d;--warn:#d97706;--error:#dc2626;--border:#e6e9f2;--shadow:0 6px 16px rgba(0,0,0,.08)
  }
  html,body{height:100%}
  body{margin:0;font-family:system-ui,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;line-height:1.6}
  .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 80px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .actions{display:flex;gap:8px}
  .btn{border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 14px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow)}
  .btn:hover{border-color:var(--accent)} .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
  .titleRow{display:flex;align-items:center;gap:14px}
  .owner{width:64px;height:64px;border-radius:9999px;object-fit:cover;border:1px solid var(--border)}
  h1{margin:0;font-size:clamp(22px,3.2vw,32px);font-weight:800;letter-spacing:.2px}
  .sub{margin-top:4px;color:var(--muted);font-size:13px}
  .switch{display:flex;align-items:center;gap:6px;color:var(--muted);font-size:13px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 14px;box-shadow:var(--shadow)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .domainRow{display:flex;gap:10px}
  input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);outline:none}
  input::placeholder{color:var(--muted)}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:12px}
  .progress{margin-top:12px;font-size:13px;color:var(--muted)}
  .list{margin-top:14px;display:grid;gap:10px}
  .row{border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(0,0,0,.04)}
  .row h3{margin:0 0 6px 0;font-size:16px}
  .kv{display:flex;gap:10px;flex-wrap:wrap}
  .kv span{font-size:12px;color:var(--muted);border:1px dashed var(--border);padding:4px 8px;border-radius:999px}
  .urls{margin-top:6px;font-size:12px;direction:ltr}
  .cta{position:sticky;bottom:0;margin-top:18px;background:var(--card);border:1px solid var(--border);padding:12px;border-radius:12px;display:flex;gap:10px;align-items:center;justify-content:space-between;box-shadow:var(--shadow)}
  .foot{margin-top:18px;color:var(--muted);font-size:12px;display:grid;gap:8px}
  .paidBar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hide{display:none !important}
  .pillOK{color:#fff;background:var(--ok);border:0}
  .pillINFO{color:#fff;background:var(--accent);border:0}
  a.link{color:var(--accent);text-decoration:none}
  .dbg{margin-top:10px;font-size:12px;color:var(--muted);white-space:pre-wrap;max-height:260px;overflow:auto;border:1px dashed var(--border);border-radius:10px;padding:8px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="actions">
        <button class="btn" id="backBtn">رجوع</button>
        <a class="btn" id="homeBtn" href="https://anasrashed.com" target="_self" rel="noopener">الرئيسية</a>
      </div>
      <div class="switch">
        <label for="themeToggle">الوضع الفاتح</label>
        <input id="themeToggle" type="checkbox" />
      </div>
    </div>

    <div class="card">
      <div class="titleRow">
        <img class="owner" src="https://anasrashed.com/ZqyGaBZ" alt="المالك">
        <div>
          <h1>اعرف الكلمات المفتاحية الخاصة بمنافسيك</h1>
          <div class="sub">
            نجلب عبارات من <b>وسم &lt;title&gt; فقط</b> بطول <b>2–5 كلمات</b>، مع <b>ذكاء مُحسّن</b> يستبعد البراند، القوالب المتكررة، الأيام/الأشهر، وضجيج الإعلانات — ونضمن أن العبارة من <b>مقطع واحد</b> وبـ <b>لغة متّسقة</b>.
          </div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="card">
        <form id="form">
          <div class="grid">
            <div class="domainRow"><input type="text" id="c1" placeholder="example.com أو https://example.com/sitemap.xml"></div>
            <div class="domainRow"><input type="text" id="c2" placeholder="اختياري: منافس ثانٍ"></div>
            <div class="domainRow"><input type="text" id="c3" placeholder="اختياري: منافس ثالث"></div>
            <div class="domainRow">
              <button type="submit" class="btn primary" id="startBtn">ابدأ التحليل (بدون حد صفحات)</button>
            </div>
          </div>
          <div class="hint">نحوّل الدومين تلقائيًا إلى /sitemap.xml. حد أعلى آمن: 20,000 رابط لكل منافس.</div>
          <div class="kpis" id="kpis"></div>
          <div class="progress" id="progress"></div>
          <div class="dbg" id="debugBox" hidden></div>
        </form>
      </div>

      <div class="card">
        <div class="kpis">
          <span class="badge" id="foundBadge">تم العثور على 0 عبارة</span>
          <span class="badge pillINFO">مجاني: يظهر أعلى 5 فقط</span>
        </div>
        <div class="paidBar">
          <input type="text" id="codeInput" placeholder="رمز الوصول (اختياري)" style="max-width:260px">
          <button class="btn" id="activateBtn">تفعيل</button>
          <button class="btn hide" id="dlCSV">تنزيل CSV</button>
          <button class="btn hide" id="dlMD">تنزيل Markdown</button>
        </div>
        <div id="results" class="list"></div>
        <div class="cta" id="cta">
          <div>تبغى القائمة كاملة؟ السعر <b>25 ريال</b> لملف CSV كامل جاهز للتنزيل.</div>
          <a class="btn primary" id="payBtn" target="_self" rel="noopener">انتقل إلى صفحة الدفع</a>
        </div>
      </div>

      <div class="foot">
        <div>المصدر: <b>عناوين الصفحات (title) فقط</b> — لا نقرأ الوصف/alt/الرابط.</div>
        <div>لا نرسل بياناتك لأي خادم غير جلب صفحات المنافسين عبر الـWorker.</div>
        <div>يمكن لاحقًا ربط Keyword Planner لإضافة الأحجام.</div>
      </div>
    </div>
  </div>

<script>
/* ====================== إعدادات ====================== */
const WORKER_BASE = 'https://keywords-tool.anasshopify88.workers.dev';
const MAX_COMPETITORS = 3;
const CONCURRENCY = 4;
const PAYMENT_LINK = 'https://anasrashed.com/azqRabz';
const RETURN_PARAM = 'paid';
const RETURN_VALUE = '1';
const ACCESS_CODE_SHA256 = [];

const NGRAM_MIN = 2, NGRAM_MAX = 5;

/* ====================== عناصر ====================== */
const el = sel => document.querySelector(sel);
const $c1 = el('#c1'), $c2 = el('#c2'), $c3 = el('#c3');
const $form = el('#form');
const $progress = el('#progress'), $results = el('#results'), $found = el('#foundBadge');
const $payBtn = el('#payBtn'), $dlCSV = el('#dlCSV'), $dlMD = el('#dlMD');
const $activate = el('#activateBtn'), $codeInput = el('#codeInput');
const $themeToggle = el('#themeToggle'); const $backBtn = el('#backBtn');
const $kpis = el('#kpis'); const $debugBox = el('#debugBox');

document.documentElement.setAttribute('data-theme', (localStorage.getItem('ck_theme') || 'dark'));
$themeToggle.checked = (localStorage.getItem('ck_theme') === 'light');
$themeToggle.addEventListener('change', () => {
  const t = $themeToggle.checked ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('ck_theme', t);
});
$backBtn.onclick = () => window.history.back();
$payBtn.href = PAYMENT_LINK;

(function handleReturnParam(){
  const params = new URLSearchParams(location.search);
  if (params.get(RETURN_PARAM) === RETURN_VALUE) localStorage.setItem('ck_paid','1');
  if (localStorage.getItem('ck_paid') === '1') { $dlCSV.classList.remove('hide'); $dlMD.classList.remove('hide'); }
})();

/* ====================== أدوات مساعدة ====================== */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function uniq(arr){ return Array.from(new Set(arr)); }
function toCSV(rows){
  return rows.map(r => r.map(v => {
    const s = (v==null?'':String(v));
    return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
  }).join(',')).join('\n');
}
function download(name, mime, data){
  const blob = new Blob([data], {type: mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url);a.remove();}, 0);
}
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ====================== قوائم لغوية/تنظيف ====================== */
const AR_STOPWORDS = new Set(["في","وفي","على","من","عن","أن","إن","او","أو","إلى","الى","و","ثم","كما","كان","كانت","يكون","ما","لا","لم","لن","قد","هذه","هذا","هو","هي","هم","هن","ذلك","تلك","أين","أينما","كيف","متى","لما","أي","أيضا","ايضا","كل","حتى","مع","بعد","قبل","بين","أثناء","حيث","لدى","لدي","التي","الذي","الذين","اللذي","اللذين","ذات","نحو","أمام","خلف","فوق","تحت","داخل","خارج","بدون","غير","مثل","عند","إذ","اذ","إذا","اذا","لكن","بل","إنما","أيما","ام","أما","أم","به","بهذا","بها","بهم","ألا","الا","هنا","هناك","منذ","ضمن","جدا","لقد","تم","تمت","ربما","يمكن","لازال","لا","زال","لايزال","لا","يزال","الرئيسيه","الرئيسية","متجر","المتجر","التصنيفات","الاقسام","العروض","الخصومات","تسوق","الشراء","الطلب","دخول","تسجيل","خروج","حساب","حسابي","اتصل","تواصل","سياسة","الخصوصية","الشروط","الاحكام","الشحن","التوصيل","الدفع","استرجاع","استبدال","تتبع","سلة","عربة","مشتريات","مدونة","المدونة","ارشيف","الأرشيف","الصفحه","صفحة","رسمي","الرسمية"]);
const EN_STOPWORDS = new Set(["the","a","an","and","or","of","for","to","in","on","with","by","at","from","as","is","are","be","home","homepage","contact","about","privacy","policy","terms","conditions","cart","checkout","account","login","register","sign","out","blog","category","archive","shop","store","compare","wishlist","return","refund","shipping","delivery","faq","help","support","official","site","website","brand"]);

const MONTHS_AR = new Set(["يناير","فبراير","مارس","ابريل","أبريل","مايو","يونيو","يوليو","اغسطس","أغسطس","سبتمبر","اكتوبر","أكتوبر","نوفمبر","ديسمبر","رمضان"]);
const MONTHS_EN = new Set(["january","february","march","april","may","june","july","august","september","october","november","december","ramadan"]);
const DAYS_AR = new Set(["الاحد","الأحد","الاثنين","الإثنين","الثلاثاء","الاربعاء","الأربعاء","الخميس","الجمعة","السبت","اليوم"]);
const DAYS_EN = new Set(["monday","tuesday","wednesday","thursday","friday","saturday","sunday","today","weekly","daily"]);

const GENERIC_HOST_PARTS = new Set(["www","m","shop","store","market","mall","app","web","site","arab","ksa","sa","com","net","org","co","io","me"]);

const AR_DIAC=/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g, AR_TATWEEL=/\u0640/g;
const HEX_PAIR_SEQ = /^(?:0x)?[0-9A-Fa-f]{2}(?:\s+(?:0x)?[0-9A-Fa-f]{2})+$/;
const MOJIBAKE_CHARS = /[ÃØÙÂ¢§]/;

const NOISE_PATTERNS = [
  /\b(تسوق|اشتري|اشتر|اطلب|سجل|دخول|تسجيل|اتصل|تواصل)\b/i,
  /\b(خصم|تخفيض|تخفيضات|عرض|عروض|كوبون|قسيمه|قسيمة)\b/i,
  /\b(شحن|توصيل)\s*(مجاني|سريع)?\b/i,
  /\b(الموقع\s+الرسمي|الرسمي)\b/i,
  /\b(الصفحه\s+الرئيسيه|الرئيسيه|الرئيسية)\b/i,
  /\b(home|official|sale|discount|coupon|deal|shop\s+now|buy\s+now)\b/i
];

/* ====================== تطبيع + أدوات نص ====================== */
function normalizeArabic(s){
  return s
    .replace(AR_DIAC,'')
    .replace(AR_TATWEEL,'')
    .replace(/[إأآا]/g,'ا').replace(/ى/g,'ي').replace(/ؤ/g,'و').replace(/ئ/g,'ي').replace(/ة/g,'ه')
    .replace(/[-_/]+/g,' ')
    .replace(/[^\p{Script=Arabic}\p{Letter}\p{Number}\s]+/gu,' ')
    .replace(/\s+/g,' ').trim();
}
function lowerLatin(s){ try{ return s.toLowerCase(); }catch{ return s; } }
function hasArabic(s){ return /\p{Script=Arabic}/u.test(s); }
function getHost(u){ try{ return new URL(u).hostname; }catch{ return ''; } }

function hostBrandTokens(urlStr){
  try{
    const u = new URL(urlStr);
    const parts = u.hostname.split('.').filter(Boolean);
    const core = parts.filter(p=>!GENERIC_HOST_PARTS.has(p.toLowerCase()));
    const raw = core.join(' ');
    const norm = normalizeArabic(raw + ' ' + raw.replace(/[-_]/g,' '));
    const toks = norm.split(/\s+/).filter(Boolean).map(t=>t.toLowerCase());
    return new Set(toks.filter(t=>t.length>=2));
  }catch{ return new Set(); }
}

function tokenizeBase(s){
  const lowered = lowerLatin(s);
  const pool = hasArabic(lowered) ? normalizeArabic(lowered) : lowered.replace(/[^\p{Letter}\p{Number}\s]+/gu,' ').replace(/\s+/g,' ').trim();
  return pool.split(/\s+/).filter(Boolean);
}

function tokenizeForHost(s, brandSet){
  const base = tokenizeBase(s);
  const out = [];
  for (const t of base){
    if (/^\d+([x×]\d+)?$/.test(t)) continue;
    if (t.length < 2) continue;
    if (AR_STOPWORDS.has(t) || EN_STOPWORDS.has(t)) continue;
    if (brandSet && brandSet.has(t)) continue;
    out.push(t);
  }
  return out;
}

function splitTitleSegments(raw){
  const sep = /[\|\-–—:\/·•»›,_()]+/g;
  return raw.split(sep).map(s=>s.trim()).filter(Boolean);
}

function ngrams(tokens, nmin=NGRAM_MIN, nmax=NGRAM_MAX){
  const out=[];
  for(let n=nmin;n<=nmax;n++){
    for(let i=0;i<=tokens.length-n;i++){
      const g=tokens.slice(i,i+n);
      out.push({ text:g.join(' '), start:i, n });
    }
  }
  return out;
}

/* ====================== فلاتر ووزن «الكلموية» ====================== */
function dominantScriptRatios(s){
  const letters = Array.from(s).filter(ch => /[A-Za-z\u0600-\u06FF]/u.test(ch));
  let ar=0,en=0;
  for(const ch of letters){
    if(/\p{Script=Arabic}/u.test(ch)) ar++;
    else if(/[A-Za-z]/.test(ch)) en++;
  }
  const total = ar+en || 1;
  return { ar: ar/total, en: en/total };
}
function languageConsistencyOK(phrase){
  const {ar,en} = dominantScriptRatios(phrase);
  return ar>=0.6 || en>=0.6;
}
function hitNoise(phrase){
  const p = lowerLatin(phrase);
  return NOISE_PATTERNS.some(re => re.test(p));
}

function isGoodKW(phrase){
  if (!phrase) return false;
  if (HEX_PAIR_SEQ.test(phrase)) return false;
  if (MOJIBAKE_CHARS.test(phrase)) return false;
  const toks = phrase.split(/\s+/).filter(Boolean);
  const n = toks.length;
  if (n < NGRAM_MIN || n > NGRAM_MAX) return false;
  if (!/[A-Za-z\u0600-\u06FF]/.test(phrase)) return false;
  if (!languageConsistencyOK(phrase)) return false;            // اتساق اللغة
  if (toks.some(t=> MONTHS_AR.has(t) || MONTHS_EN.has(t) || DAYS_AR.has(t) || DAYS_EN.has(t))) return false; // استبعاد الأشهر/الأيام أينما ظهرت
  if (!toks.some(t=>t.length>=4)) return false;                // لازم كلمة طولها ≥4
  if (toks.some(t=>t.length>30)) return false;                 // كلمات غير طبيعية
  if (hitNoise(phrase)) return false;                          // عبارات تسويقية عامة
  const uniq = new Set(toks.map(t=>t.toLowerCase()));
  if (uniq.size/n < 0.6) return false;                         // تكرار عالي
  return true;
}

function keywordLikeness(phrase){
  const s = phrase;
  const letters = (s.match(/[A-Za-z\u0600-\u06FF]/g)||[]).length;
  const digits  = (s.match(/[0-9]/g)||[]).length;
  const total   = s.replace(/\s+/g,'').length || 1;
  const lettersRatio = letters/total;
  const digitRatio   = digits/total;
  const toks = s.split(/\s+/).filter(Boolean);
  const uniqRatio = (new Set(toks.map(t=>t.toLowerCase()))).size / toks.length;

  if (lettersRatio < 0.70) return { ok:false, weight:0 };
  if (digitRatio   > 0.40) return { ok:false, weight:0 };
  if (uniqRatio    < 0.60) return { ok:false, weight:0 };

  const base = 0.6*lettersRatio + 0.4*uniqRatio;              // (0..1)
  const lenBonus = (toks.length>=4 ? 1.1 : 1.0);
  return { ok:true, weight: base * lenBonus };
}

/* ====================== جلب البيانات ====================== */
function canonicalizeInput(v){
  v=v.trim(); if(!v) return '';
  try{ if(!/^https?:\/\//i.test(v)) v='https://'+v; const u=new URL(v);
    if(!/\.xml(\.gz)?$/i.test(u.pathname)) u.pathname='/sitemap.xml';
    return u.toString();
  }catch{ return ''; }
}
async function fetchJSON(u){ const r = await fetch(u,{headers:{accept:'application/json'}}); if(!r.ok) throw new Error(`HTTP ${r.status}`); return await r.json(); }
async function fetchSitemap(workerBase, siteOrMap){
  const u = new URL(workerBase + '/sitemap'); u.searchParams.set('url', siteOrMap);
  u.searchParams.set('max','0');
  return await fetchJSON(u.toString());
}
async function fetchPage(workerBase, url){
  const u = new URL(workerBase + '/page'); u.searchParams.set('url', url);
  return await fetchJSON(u.toString());
}

async function poolAll(urls, workerBase, onTick){
  const results=[]; let idx=0, active=0, done=0;
  return new Promise((resolve)=>{
    const next=()=>{
      if(done===urls.length && active===0) return resolve(results);
      while(active<CONCURRENCY && idx<urls.length){
        const my=idx++; const u=urls[my]; active++;
        fetchPage(workerBase, u).then(j=>{ results[my]=j; })
        .catch(e=>{ results[my]={ok:false,url:u,error:String(e)}; })
        .finally(()=>{ active--; done++; onTick(done, urls.length); next(); });
      }
    }; next();
  });
}

/* ====================== إعداد مسبق لكل صفحة ====================== */
function preparePages(pages){
  const infos=[];
  for (const p of pages){
    if (!p || !p.ok) continue;
    const titleRaw = (p.title||'').trim();
    if (!titleRaw) continue;
    const brand = hostBrandTokens(p.url||'');
    const host = getHost(p.url||'');
    infos.push({ url:p.url, host, titleRaw, brand });
  }
  return infos;
}

/* استخراج “ضجيج” العنوان المتكرر لكل دومين (Boilerplate) */
function buildHostBoilerTokens(infos, freq=0.60){
  const hostTokenFreq = new Map();
  const hostPageCount = new Map();
  for (const it of infos){
    const tokens = tokenizeForHost(it.titleRaw, it.brand);
    const seen = new Set(tokens);
    hostPageCount.set(it.host, (hostPageCount.get(it.host)||0) + 1);
    for (const t of seen){
      const map = hostTokenFreq.get(it.host) || new Map();
      map.set(t, (map.get(t)||0) + 1);
      hostTokenFreq.set(it.host, map);
    }
  }
  const boiler = new Map();
  for (const [host, freqMap] of hostTokenFreq){
    const total = hostPageCount.get(host)||1;
    const set = new Set();
    for (const [tok, c] of freqMap){
      if (c/total >= freq && tok.length>=3) set.add(tok);
    }
    boiler.set(host, set);
  }
  return { boiler, hostPageCount };
}

/* ====================== التجميع الذكي (مقاطع العنوان فقط) ====================== */
function aggregateSmart(pages){
  const infos = preparePages(pages);
  const { boiler } = buildHostBoilerTokens(infos, 0.60);

  const DF=new Map(), TF=new Map(), FLAGS=new Map(), SAMPLES=new Map(), HOSTS=new Map(), POSW=new Map();
  let N = 0;

  for (const it of infos){
    N++;
    const noise = new Set([...(boiler.get(it.host)||new Set()), ...(it.brand||new Set())]);

    // قسّم العنوان لمقاطع مستقلّة
    const segments = splitTitleSegments(it.titleRaw);

    const seenGram = new Set();
    segments.forEach((seg, segIdx) => {
      // رمّز المقطع وأزل البراند/البويلر
      const segTokensRaw = tokenizeForHost(seg, it.brand);
      const segTokens = segTokensRaw.filter(t => !noise.has(t));
      if (segTokens.length < NGRAM_MIN) return;

      const grams = ngrams(segTokens, NGRAM_MIN, NGRAM_MAX);
      for (const g of grams){
        const phrase = g.text;
        if (seenGram.has(phrase)) continue;
        if (!isGoodKW(phrase)) continue;
        const { ok, weight } = keywordLikeness(phrase);
        if (!ok) continue;

        // تعزيز للمقطع الأول + عبارات تبدأ من أوّل الكلمة بالمقطع
        const segBoost = (segIdx===0 ? 1.20 : 1.00) * (g.start===0 ? 1.05 : 1.00);

        // تجميع إحصاءات
        DF.set(phrase,(DF.get(phrase)||0)+1);
        TF.set(phrase,(TF.get(phrase)||0)+1);
        POSW.set(phrase,(POSW.get(phrase)||0)+segBoost*weight);

        FLAGS.set(phrase,{in_title:1});
        const ss=SAMPLES.get(phrase)||new Set(); if(ss.size<2) ss.add(it.url); SAMPLES.set(phrase,ss);
        const hs=HOSTS.get(phrase)||new Set(); hs.add(it.host); HOSTS.set(phrase,hs);

        seenGram.add(phrase);
      }
    });
  }

  const out=[];
  for (const [k, tf] of TF.entries()){
    const df = DF.get(k)||1;
    const idf = Math.log((N+1)/(df+1))+1;
    const hostCoverage = (HOSTS.get(k)||new Set()).size;
    const hostBoost = 1 + Math.min(0.30, 0.10 * (hostCoverage-1));
    const posw = POSW.get(k)||1.0;
    const score = tf * idf * hostBoost * (posw / Math.max(1, df));

    out.push({
      keyword:k,
      score:+score.toFixed(6),
      tf, df,
      pages_count:df,
      in_title:1,
      host_df:hostCoverage,
      sample_urls:Array.from(SAMPLES.get(k)||[])
    });
  }
  out.sort((a,b)=>b.score-a.score);
  return out;
}

/* ====================== عرض ====================== */
let ALL_RESULTS=[];
function escapeHTML(s){return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}
function render(list){
  const paid=(localStorage.getItem('ck_paid')==='1'); $dlCSV.classList.toggle('hide',!paid); $dlMD.classList.toggle('hide',!paid);
  $found.textContent=`تم العثور على ${list.length} عبارة`;
  const show=paid?list:list.slice(0,5); $results.innerHTML='';
  for(const r of show){
    const div=document.createElement('div'); div.className='row';
    div.innerHTML=`
      <h3>${escapeHTML(r.keyword)}</h3>
      <div class="kv">
        <span>Score: ${r.score}</span>
        <span>TF: ${r.tf}</span>
        <span>DF: ${r.df}</span>
        <span>Hosts: ${r.host_df}</span>
        <span class="pillOK">from_title: ✓</span>
      </div>
      <div class="urls">${r.sample_urls.map(u=>`<a class="link" href="${u}" target="_blank" rel="noopener">${u}</a>`).join('  ')}</div>`;
    $results.appendChild(div);
  }
}

/* CSV / MD */
function buildCSVRows(items){
  const header=['keyword','score','tf','df','pages_count','host_df','from_title','sample_urls'];
  const rows=[header]; for(const r of items){ rows.push([r.keyword,r.score,r.tf,r.df,r.pages_count,r.host_df,r.in_title,r.sample_urls.join(' ')]); }
  return rows;
}
function buildMarkdown(items){
  const groups=new Map();
  for(const r of items){ const head=r.keyword.split(' ')[0]||r.keyword; if(!groups.has(head)) groups.set(head,[]); groups.get(head).push(r); }
  let md=`# ملخص عبارات العنوان (2–5 كلمات)\n\n`;
  for(const [head,arr] of groups){ const top=arr.slice(0,Math.min(10,arr.length)); md+=`## ${head}\n\n`; for(const r of top){ md+=`- **${r.keyword}** — Score: ${r.score} | صفحات: ${r.pages_count} | دومينات: ${r.host_df}\n`; } md+=`\n`; }
  md+=`\n> المصدر: وسوم العنوان فقط (TF-IDF + Segment-only + Host coverage + Language consistency).\n`; return md;
}
$dlCSV.onclick=()=>{ if(localStorage.getItem('ck_paid')!=='1') return; const csv=toCSV(buildCSVRows(ALL_RESULTS)); download('competitors_title_keywords.csv','text/csv;charset=utf-8',csv); }
$dlMD.onclick=()=>{ if(localStorage.getItem('ck_paid')!=='1') return; const md=buildMarkdown(ALL_RESULTS); download('competitors_title_keywords.md','text/markdown;charset=utf-8',md); }

/* تفعيل برمز */
$activate.addEventListener('click', async ()=>{
  const raw=($codeInput.value||'').trim(); if(!raw) return;
  const hex=await sha256Hex(raw);
  if(ACCESS_CODE_SHA256.includes(hex)){ localStorage.setItem('ck_paid','1'); $dlCSV.classList.remove('hide'); $dlMD.classList.remove('hide'); alert('تم التفعيل.'); }
  else{ alert('رمز غير صحيح.'); }
});

/* ====================== السريان ====================== */
function showDebug(obj){
  try{ $debugBox.hidden=false; $debugBox.textContent = JSON.stringify(obj,null,2); }catch{ $debugBox.hidden=false; $debugBox.textContent=String(obj); }
}

$form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  $results.innerHTML=''; $progress.textContent=''; ALL_RESULTS=[]; $found.textContent='تم العثور على 0 عبارة'; $kpis.innerHTML=''; $debugBox.hidden=true;

  const inputs=[$c1.value,$c2.value,$c3.value].map(v=>v.trim()).filter(Boolean);
  if(inputs.length===0){ alert('أدخل منافسًا واحدًا على الأقل'); return; }
  if(inputs.length>MAX_COMPETITORS){ alert(`مسموح حتى ${MAX_COMPETITORS} منافسين`); return; }

  try{
    // 1) خرائط المواقع
    let allUrls=[];
    for(let i=0;i<inputs.length;i++){
      const siteOrMap=canonicalizeInput(inputs[i]);
      if(!siteOrMap){ alert('تنسيق الإدخال غير صحيح'); return; }
      $progress.textContent=`جاري قراءة خريطة الموقع للمنافس ${i+1} ...`;
      try{
        const sm=await fetchSitemap(WORKER_BASE, siteOrMap);
        if(!sm.ok){ throw new Error('sitemap not ok'); }
        const urls=(sm.urls||[]);
        allUrls=allUrls.concat(urls);
        const b=document.createElement('span'); b.className='badge'; b.textContent=`${new URL(siteOrMap).hostname}: ${urls.length} رابط`;
        $kpis.appendChild(b);
        if((urls.length===0) && sm.debug){ showDebug({ reason:'Empty sitemap urls', input:inputs[i], debug:sm.debug }); }
      }catch(err){
        showDebug({ reason:'sitemap fetch error', input:inputs[i], error:String(err) });
      }
      await sleep(120);
    }
    allUrls=uniq(allUrls);
    if(allUrls.length===0){ alert('لم يتم العثور على روابط صفحات'); return; }

    // 2) جمع الصفحات
    let doneCount=0;
    $progress.textContent=`جاري جمع الصفحات… ${doneCount} / ${allUrls.length}`;
    const pages=await poolAll(allUrls, WORKER_BASE, (d,total)=>{ doneCount=d; $progress.textContent=`جاري جمع الصفحات… ${d} / ${total}`; });

    const fails=pages.filter(p=>!p||!p.ok);
    if(fails.length===pages.length){ showDebug({ reason:'all page fetches failed', sample:fails.slice(0,5) }); }

    // 3) تحليل ذكي — Title فقط (داخل المقطع)
    $progress.textContent='جاري التحليل…'; await sleep(50);
    ALL_RESULTS=aggregateSmart(pages);
    render(ALL_RESULTS);
    $progress.textContent='اكتمل التحليل.';
  }catch(err){
    showDebug({ reason:'top-level error', error:String(err) });
    alert('حدث خطأ غير متوقع. راجع صندوق التشخيص أسفل النموذج.');
  }
});
</script>
</body>
</html>
